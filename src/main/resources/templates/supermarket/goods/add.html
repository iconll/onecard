<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:include="include/includebase"></head>
<body>
<form id="roleForm"  role="form" method="post" action="/goods/save">
    <div class="row">
        <div class="col-md-7">
            <div class="form-group" >
                <label for="name">分类名称:</label>
                <input type="text" class="form-control" name="name" id="name"  placeholder="请输入分类名称" />
            </div>
            <div class="form-group" >
                <label>上级分类:</label>
                <select class="form-control" οnchange="selectOnchang(this)">
                    <option>根目录</option>
                </select>
            </div>
            <div class="form-group" >
                <label for="name0">单价:</label>
                <input type="text" class="form-control" name="name0" id="name0"  placeholder="请输入单价" />
            </div>
            <div class="form-group" >
                <label for="name1">单位:</label>
                <input type="text" class="form-control" name="name1" id="name1"  placeholder="请输入单位" />
            </div>
            <div class="form-group" >
                <label for="name2">规格:</label>
                <input type="text" class="form-control" name="name2" id="name2"  placeholder="请输入规格" />
            </div>
            <div class="form-group" >
                <label for="name3">税率:</label>
                <input type="text" class="form-control" name="name3" id="name3"  placeholder="请输入税率" />
            </div>
            <div class="form-group" >
                <label for="name4">描述:</label>
                <input type="text" class="form-control" name="name4" id="name4"  placeholder="请输入描述" />
            </div>
        </div>
        <div class="col-md-5">
            <input type="file" id="imgPicker"/>
            <img  id="preview" src="../img/uploadImg.png" style="width: 12.5rem;height: 12.5rem;margin-top: 1rem">
        </div>
    </div>
</form>
<script th:inline="javascript">
    <![CDATA[
    $(function () {
        $('#roleForm').bootstrapValidator({
            message: 'This value is not valid',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                name: {
                    message: '分类名称验证失败',
                    validators: {
                        notEmpty: {
                            message: '分类名称不能为空'
                        },
                        threshold :  2 , //有6字符以上才发送ajax请求，（input中输入一个字符，插件会向服务器发送一次，设置限制，6字符以上才开始）
                        remote: {//ajax验证。server result:{"valid",true or false} 向服务发送当前input name值，获得一个json数据。例表示正确：{"valid",true}
                            url: "role/isExist",//验证地址
                            data:function(validator) {// 获取需要传送到后台的验证的数据
                                return {
                                    name:$("#name").val()
                                }
                            },
                            message: '分类名称已存在',//提示消息
                            delay :  500,//每输入一个字符，就发ajax请求，服务器压力还是太大，设置2秒发送一次ajax（默认输入一个字符，提交一次，服务器压力太大）
                            type: 'POST'//请求方式
                        }
                    }
                },
            }
        })

        // 绑定dialog的确定按钮的监听事件
        $("#btnOk",window.top.document).click(function() {
            var t = $.fn.zTree.getZTreeObj("roleZtree");
            var nodes = t.getCheckedNodes(true);
            var treeArray = "";
            for(var i=0;i<nodes.length;i++){
                if(i==0){
                    treeArray = nodes[i].id
                }else{
                    treeArray =  treeArray + "," + nodes[i].id
                }
            }
            $("#treeArray").attr("value",treeArray);
            // 此段是为防止需要点击两次按钮来实现验证的方法，若不添加此处的放行，那么我们将要点击两次确定按钮才可以提交验证
            var name = $("#name").val();
            // 判断当前的code又值，且当前不存在错误验证方可放开该字段的验证
            if(name != null && name != ""&&$("#name").parent("div").find('.glyphicon-remove').length==0){
                $('#roleForm').bootstrapValidator('enableFieldValidators', 'name', false);
            } else {
                $('#roleForm').bootstrapValidator('enableFieldValidators', 'name', true);
            }
            var bootstrapValidator = $("#roleForm", window.top.document).data('bootstrapValidator');
            bootstrapValidator.validate();
            if(bootstrapValidator.isValid()){
                $.post($("#roleForm",window.top.document).attr('action'),$("#roleForm",window.top.document).serialize(),function(e){
                    if(e.result){
                        $('.modal-dialog', window.top.document).parent('div').remove()
                        $('body', window.top.document).find('.modal-backdrop').remove();
                        // jquery 调用刷新当前操作的table页面的refresh方法
                        $(window.parent.document).contents().find(".tab-pane.fade.active.in iframe")[0].contentWindow.doQuery();
                        window.Ewin.alert({message:'增加数据成功!'});
                    }else{
                        window.Ewin.alert({message:'增加数据失败!'});
                    }
                })
            }else{
                return false;
            }
        });


        var setting = {
            check: {
                enable: true
            },
            view: {
                dblClickExpand: false,
                showLine: true,
                selectedMulti: false
            },
            data: {
                simpleData: {
                    enable:true,
                    idKey: "id",
                    pIdKey: "pId",
                    rootPId: "0"
                }
            },
            callback: {
                beforeClick: function(treeId, treeNode) {
                    var zTree = $.fn.zTree.getZTreeObj('roleZtree');
                    if (treeNode.isParent) {
                        zTree.expandNode(treeNode);
                        return false;
                    } else {
                        return true;
                    }
                }
            }
        };

        $.post("/tree/loadUserTree",function(info){
            var t = $("#roleZtree");
            t = $.fn.zTree.init(t, setting,info.data);
        })
    })
    //上传图片
    document
        .querySelector('#imgPicker')
        .addEventListener('change', function(){
            //当没选中图片时，清除预览
            if(this.files.length === 0){
                document.querySelector('#preview').src = '';
                return;
            }

            //实例化一个FileReader
            var reader = new FileReader();

            reader.onload = function (e) {
                //当reader加载时，把图片的内容赋值给
                document.querySelector('#preview').src = e.target.result;
            };

            //读取选中的图片，并转换成dataURL格式
            reader.readAsDataURL(this.files[0]);
        }, false);
    ]]>
</script>
</body>
</html>